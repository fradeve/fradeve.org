---
title: "Usare rsync con Box.net"
created: !!timestamp '2012-03-23 23:00:00'
charset: utf-8
featured: yes
tags:
    - server
---

_Ultimo aggiornamento: 17 aprile 2012_

In questi giorni, [Box.net][1] sta regalando 50 Gb di spazio a chiunque apra un nuovo account e faccia almeno un login dall'applicazione ufficiale per Android, occasione davvero ghiotta. È la prima volta che utilizzo questo servizio e la prima cosa che ho notato, con enorme sconcerto, è che Box.net non supporta in nessun modo il _timestamp_ dei file. In altre parole, tutte le informazioni presenti nel file relativi alla data dell'ultima modifica (tanto per dirne una) vengono sovrascritte, con [sommo disappunto degli utenti][2]. Per chi avrebbe tanto voluto 50 Gb di cloud per fare una copia speculare e sincronizzata delle proprie foto, video, documenti con lo straordinario [rsync][3], tempi bui.

Almeno, fino all'arrivo di tale S0M30N3 che, in un fantastico quanto conciso [howto][4] ha tirato fuori dal cilindro un sistema per usare rsync in una partizione criptata con [EncFS][5] creata all'interno della propria Box cloud. Ho testato personalmente il gioco e, porca paletta, funziona. Il tutorial che segue è stato provato su Ubuntu 11.04.

### Pro

* i dati vengono trasmessi via https e inseriti in una partizione criptata all'interno della cartella: sono illeggibili da chiunque non conosca la password non solo dell'account Box.net, ma del filesystem criptato
* è l'unico modo per usare lo straordinario rsync con i propri 50 Gb di cloud
* tutti i vantaggi che derivano da rsync: personalizzazione del backup, integrazione con cron, ecc.

### Contro

* i dati essendo cifrati sui server di Box.net, non possono essere letti dalle varie app (compresa quella per Android); occorre avere una macchina su cui montare la partizione EncFS e solo allora potremo accedere ai dati; a anche se, a ben pensarci... leggete fino in fondo ;)
* Box.net per gli account gratuiti ha un limite di 100 Mb/file, non dimenticatelo; lo script di rsync riportato di seguito penserà a limitare la sincronizzazione ai soli file al di sotto di questa dimensione
* la sincronizzazione sembra essere un po' lenta

## 1 - Montare la Box in `/media` tramite WebDAV ##

La cartella di WebDAV può essere montata sia dall'utente che sta utilizzando la macchina sia dall'account di root. In questa guida è seguita la prima opzione, che unita ad una adeguata [cifratura della cartella Home][14], permette di mantenere un buon livello di privacy sui propri dati.

Installare davfs2

	sudo apt-get install davfs2

Permettere all'utente non-root di montare DavFS, rispondendo `Yes` alla riconfigurazione del pacchetto

	sudo dpkg-reconfigure davfs2

Aggiungere l'utente che utilizzerà DavFS2 al gruppo omonimo:

	sudo adduser $USER davfs2

creare la cartella in cui verrà montata la Box

	sudo mkdir /media/box

inserire la seguente riga in `/etc/fstab`:
<!-- inserire la seguente riga in `/etc/fstab`, sostituendo al posto di `1000` in `uid` e `gid` l'userid e il groupid dell'utente che accederà alla Box: -->
<!-- https://www.box.com/dav /media/box davfs rw,suid,dev,exec,noauto,nouser,async,uid=1000,gid=1000 0 0 -->

	https://www.box.com/dav /media/box      davfs   noauto,user   0   0

Il file `/etc/davfs2/davfs2.conf` contiene le impostazioni valide per tutto il sistema; decommentare la seguente riga:

        use_locks       0

Creare una copia del file delle configurazioni nella propria home

	mkdir ~/.davfs2
	cp /etc/davfs2/davfs2.conf ~/.davfs2

Per evitare di dover inserire ogni volta le credenziali di accesso alla Box in fase di mount, creare il file `secrets`, attribuirgli i permessi corretti (`600`)

	sudo cp /etc/davfs2/secrets ~/.davfs2
	sudo chown $USER ~/.davfs2/secrets
	sudo chmod 600 ~/.davfs2/secrets

ed inserirvi i dati di accesso

	/media/box	user@email.com	password

Il file `~/.davfs/davfs2.conf` contiene le impostazioni per l'utente; in questo, specificare la posizione del file delle password appena creato, decommentando la riga come segue

	secrets         ~/.davfs2/secrets

Possiamo dotarci di _alias_ in `~/.bashrc` per montare e smontare rapidamente la Box (ricordando di dare un `source ~/.bashrc` per rendere operativi gli alias):

	alias boxmount='mount /media/box'
	alias boxumount='umount /media/box'

Proviamo a montare la Box con il comando `boxmount`. Il montaggio della Box al login (e solo dopo la disponibilità di una connessione internet, per evitare errori) può essere [automatizzato][10]. Se tutto procede bene, andiamo oltre.

*ATTENZIONE*: Il parametro `cache_size` in `~/.davfs2/davfs2.conf` è commentato di default. Ciò significa che man mano che DavFS2 trasferisce i file dal filesystem locale a quello remoto di Box, ne lascia una copia (criptata) nella cache. Non avendo nessun limite impostato, ciò potrebbe riempire la partizione in cui è presente la cache (impedendo ad Ubuntu di avviarsi se la cache è nella partizine root -- GNU/Linux deve avere almeno il 4% di spazio libero in root). È pertanto vivamente consigliato di abilitare il parametro `cache_size`, impostando un limite ragionevole (per me 250 Mb).

## 2 - Creare una cartella criptata nella Box ##

Alcune spiegazioni:

* *media/box*: punto di mount della Box via WebDAV
* *media/box/backup*: la cartella che _fisicamente_ conterrà i dati, nella nostra Box
* *media/box.encfs* la cartella in cui verrà montato il filesystem criptato, non leggibile
* *media/box.backup*: la cartella in cui riverseremo i nostri dati da backuppare, collegata a `box.encfs`

Installare EncFS ed aggiungere il proprio utente al gruppo `fuse`

	sudo apt-get install encfs
	sudo addgroup <USER> fuse

decommentare la seguente riga in `/etc/fuse.conf`

	user_allow_other

creare la cartella che conterrà il filesystem criptato, sistemare i permessi (sostituire ad `<USER>` il proprio nome utente sulla macchina)

	sudo mkdir /media/box.encfs
	sudo chown <USER>:<USER> /media/box.encfs

creare la cartella che ospiterà il filesystem criptato e il filesystem criptato

	mkdir /media/box/backup/
	encfs /media/box/backup/ /media/box.encfs/

durante la creazione, ci verranno chieste informazioni relative al sistema di cifratura; consiglio di selezionare l'opzione di default. Al termine della procedura, il filesystem criptato sarà attivo nella nostra Box.

## 3 - Installare gli script per correggere le timestamp ##

La vera chicca: questi script fanno in modo che i file nel nostro filesystem criptato conservino le timestamp, permettendo a rsync di lavorare. Scaricare gli script con

	wget http://bazaar.launchpad.net/~germar/fusetime/trunk/download/head:/fusetime.py-20120119150228-brsqa2ewllb9euc5-1/fusetime.py
	wget http://fusepy.googlecode.com/svn/trunk/fuse.py

correggere i permessi, spostarli nella cartella degli eseguibili

	sudo chown root:root fusetime.py fuse.py
	sudo chmod 755 fusetime.py fuse.py
	sudo mv fusetime.py fuse.py /usr/local/bin/

## 4 - Creare la cartella per la sincronizzazione e avviare rsync ##

Questo passaggio permetterà di correggere le timestamp grazie agli script installati prima e di avere in `/media` una cartella che avremo come destinazione per i nostri backup, collegata con quella criptata creata precedentemente. Creare la cartella, attribuire i permessi e avviare lo script sulle cartelle

	sudo mkdir /media/box.backup
	sudo chown <USER>:<USER> /media/box.backup
	fusetime.py /media/box.encfs/ /media/box.backup/

In caso di problemi o errori relativi a con `fusermount`, soluzione è [a portata di mano][8]. Installare rsync

	sudo apt-get install rsync

Avviare _finalmente_ la sincronizzazione, sostituendo `/path/to/files` al percorso che vogliamo backuppare; di seguito è riportata un'istanza di rsync con opzioni "base", che andrà bene per qualsiasi esigenza

	rsync -r -a -i --times --delete --max-size=99.5M --no-perms --no-group --progress /path/to/files /media/box.backup/

Per sincronizzare le mie immagini, ho inserito qualche altra opzione per non copiare nel backup i file `Thumbs.db`, quelli che con estensione `.xmp` e `.bak`; vengono inoltre usati dei file parziali (così da non dover ricominciare da capo il backup di file di grosse dimensioni in caso di interruzioni) e man mano che il programma opera viene mostrato un log in tempo reale che mostra ogni singola operazione di rsync:

	rsync -r -a -i --times --exclude '*.xmp' --exclude '*.bak' --exclude 'Thumbs.db' --delete \\
	--max-size=99.5M --no-perms --no-group -P -v -v /media/dati/archivio/immagini/ /media/box.backup/

Ricordare che in `/media/box.backup/` possiamo creare qualsiasi sottocartella, abbiamo la massima libertà; ad esempio, potremo avere rispettivamente come origine e destinazione del backup:

	/home/fradeve/Immagini	/media/box.backup/Immagini
	/home/fradeve		/media/box.backup/fradeve

Potremo quindi dimenticarci di tutte le altre cartelle create, che sono soltanto funzionali al sistema degli script e del filesystem, lavorando semplicemente su `/media/box.backup`. Quando la sincronizzazione sarà finita, potremo smontare le partizioni con i seguenti comandi

	fusermount -u /media/box.backup
	fusermount -u /media/box.encfs
	umount /media/box

Consiglio vivamente, dopo aver dato il comando di `umount` per smontare la Box via WebDAV, di attendere che davfs finisca di scrivere le modifiche ancora in cache sulla risorsa WebDAV che, come si può intuire dal parametro `async` di `/etc/fstab`, era stata montata per l'I/O asincrono per ottimizzarne le prestazioni; se si tenta di killare il processo mentre sta scrivendo i dati ancora in cache potrebbero verificarsi perdite di dati.

Dopo un eventuale riavvio del sistema, potremo far ripartire tutto montando nuovamente il filesystem criptato e avviando lo script

	encfs /media/box/backup/ /media/box.encfs/
	fusetime.py /media/box.encfs/ /media/box.backup/

oppure, concatenando i comandi per montare la Box, montare la partizione criptata (che richiederà comunque l'inserimento manuale della password) e lo script fusetime, è possibile creare un alias in `.bashrc` che faccia tutto da solo:

	alias boxmount='mount /media/box && encfs /media/box/backup/ /media/box.encfs/ && fusetime.py /media/box.encfs/ /media/box.backup/'

fatto ciò, potremo avviare il comando di rsync riportato sopra. Il montaggio di filesystem cifrati in GNOME può essere automatizzato usando [gnome-encfs][9].

## 5 - Aggiungere sicurezza ##

ATTENZIONE: questa sezione è ancora in fase di testing, ed ho avuto molti problemi nel farla funzionare. Attendere ulteriori sviluppi prima di testarla sui propri dati. In breve: nonostante teoricamente tutto debba funzionare come riportato di seguito, una volta cancellato il file `encfs6.xml` dalla radice della cartella cifrata, il filesystem cifrato non viene più montato.

È sufficiente consultare qualche [howto][12] tecnico relativo ad EncFS per rendersi conto che ci sono alcune problematiche di sicurezza all'interno di un'installazione standard:

	Most of the encrypting information (apart from password) including
	iteration count, and salt, is visible in the encfs config file at the top
	level of the encfs directory tree.  This provides valuable information to
	a hacker.

In altre parole, all'interno di ogni filesystem criptato creato con EncFS viene generato un file, `.encfs6.xml` che non contiene (no di certo!) la password di cifratura, ma riassume comunque informazioni che potrebbero tornare utili a chiunque voglia tentare di decifrare i dati a nostra insaputa. Inoltre, per ovvi motivi, essendo un file di configurazione, non è criptato come il resto dei dati, per questo sarebbe meglio copiarlo in un dispositivo sicuro (una penna USB) ed eliminarlo dalla cartella "in chiaro" Box.net (dove rimarrebbe leggibile a chiunque abbia la password del nostro account). Il file deve essere comunque presente nel nostro sistema, da qualche parte, perché è essenziale per decifrare il filesystem criptato (almeno quanto la password). Al momento di montare il filesystem, indicheremo ad EncFS dove prendere il file delle impostazioni. Vediamo come.

Spostiamo il file nella nostra home, eliminandolo dalla Box 

	mv /media/box/backup/.encfs6.xml ~/.encfs6_box.xml

Al nuovo comando per montare il filesystem criptato verrà aggiunto (anche nel vostro eventuale `.bashrc`) un parametro che indica dove reperire il file xml corretto; tale parametro varia in funzione della versione di EncFS (per cui EncFS 1.6 avrà `ENCFS&_CONFIG`, EncFS 1.7 avrà `ENCFS7_CONFIG`):

	ENCFS6_CONFIG="~/.encfs6_box.xml" encfs /media/box/backup/ /media/box.encfs/

Questo significa anche che:

* se un giorno configurerete una nuova macchina per accedere alla vostra Box criptata, `.encfs6_box.xml` dovrete inserirlo a mano nel sistema, perché non sarà più presente in Box. Se non sapete come garantire la sicurezza della copia di `.encfs6_box.xml` che avrete salvato in una penna USB, è possibile cifrarlo con [GPG][13] o usare la [steganografia][14]
* se usate gnome-encfs per montare la partizione all'avvio, dovrete fare attenzione a specificare il percorso di `.encfs6_box.xml` perché tutto funzioni automaticamente al login

## Integrazioni ##

Sicuramente l'impossibilità di accedere da qualunque dispositivo ai propri dati, e la macchinosità di dover montare sulla macchina dalla quale si vuole accedere una partizione WebDAV e poi configurare EncFS e i vari script è demotivante. Tuttavia, armandosi di un VPS e un po' di pazienza, si potrebbe configurare un'istanza di [ownCloud][6], che potrebbe accedere ai file tramite una configurazione come quella descritta nella sezione 1, montata semplicemente in `/media/data`. Tra l'altro, ownCloud ha anche un'[applicazione per Android][7]: e con questo, chiudo.

## Ulteriori riferimenti ##

* [Guida sul wiki di Ubuntu-fr][11]
* [Guida su tomalison.com][16]
* [Thread su forum.ubuntu.com][17]

   [1]: http://box.net 
   [2]: http://community.box.com/boxnet/topics/does_box_net_support_timestamps?from_gsfn=true
   [3]: https://rsync.samba.org/
   [4]: http://www.heise.de/mobil/newsticker/foren/S-Re-rsync-zu-Box-net/forum-222786/msg-21487182/read/
   [5]: http://www.arg0.net/encfs
   [6]: http://owncloud.org/
   [7]: http://owncloud.org/support/android/
   [8]: http://blog.seljebu.no/2011/05/encfs-over-sshfs-on-linux-mint-10/
   [9]: https://bitbucket.org/obensonne/gnome-encfs
   [10]: http://blog.nguyenvq.com/2011/12/08/mount-box-net-on-ubuntu-linux-via-webdav/
   [11]: http://doc.ubuntu-fr.org/davfs2
   [12]: http://www.ict.griffith.edu.au/anthony/info/crypto/encfs.hints
   [13]: http://www.gnupg.org/howtos/it/GPGMiniHowto-3.html
   [14]: http://steghide.sourceforge.net/documentation.php
   [15]: https://help.ubuntu.com/community/EncryptedHome
   [16]: http://tomalison.com/reference/2010/04/03/webdav/
   [17]: http://ubuntuforums.org/showpost.php?p=11258734&postcount=34

